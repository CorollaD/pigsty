---
#==============================================================#
# Check pgbouncer installed
#==============================================================#
- name: Check pgbouncer is installed
  tags: pgbouncer_check
  shell: "[[ -f /bin/pgbouncer ]]"


#==============================================================#
# Cleanup existing pgbouncer
#==============================================================#
- import_tasks: cleanup.yml


#==============================================================#
# Config pgbouncer
#==============================================================#
- import_tasks: config.yml


#==============================================================#
# Launch pgbouncer
#==============================================================#
- import_tasks: launch.yml


#==============================================================#
# Register pgbouncer service (optional)
#==============================================================#
- name: Register pgbouncer consul service
  tags: pgbouncer_register
  ignore_errors: true
  block:
    - name: Copy pgbouncer service definition
      template:
        src: svc-pgbouncer.json.j2
        dest: /etc/consul.d/svc-pgbouncer.json
        owner: consul
        group: postgres
        mode: 0660

    - name: Reload pgbouncer consul service
      systemd: name=consul state=reloaded

...